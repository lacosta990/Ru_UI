#!/system/bin/sh

/usbdbg.sh device

TF1_PATH=/mnt/mmc # ROMS partition
TF2_PATH=/mnt/sdcard
SDCARD_PATH=$TF1_PATH
SYSTEM_DIR=/.system
SYSTEM_FRAG=$SYSTEM_DIR/rg35xx
UPDATE_FRAG=/RUUIhardcore.zip
SYSTEM_PATH=${SDCARD_PATH}${SYSTEM_FRAG}
UPDATE_PATH=${SDCARD_PATH}${UPDATE_FRAG}

mkdir /mnt/sdcard
if [ -e /dev/block/mmcblk1p1 ]; then
	SDCARD_DEVICE=/dev/block/mmcblk1p1
else
	SDCARD_DEVICE=/dev/block/mmcblk1
fi
mount -t vfat -o rw,utf8,noatime $SDCARD_DEVICE /mnt/sdcard
if [ $? -ne 0 ]; then
	mount -t exfat -o rw,utf8,noatime $SDCARD_DEVICE /mnt/sdcard
	if [ $? -ne 0 ]; then
		rm -rf $TF2_PATH
		ln -s $TF1_PATH $TF2_PATH
	fi
fi

if [ -d ${TF1_PATH}${SYSTEM_FRAG} ] || [ -f ${TF1_PATH}${UPDATE_FRAG} ]; then
	if [ ! -L $TF2_PATH ]; then
		# .system found on TF1 but TF2 is present
		# so unmount and symlink to TF1 path
		umount $TF2_PATH
		rm -rf $TF2_PATH
		ln -s $TF1_PATH $TF2_PATH
	fi
fi

SDCARD_PATH=$TF2_PATH
SYSTEM_PATH=${SDCARD_PATH}${SYSTEM_FRAG}
UPDATE_PATH=${SDCARD_PATH}${UPDATE_FRAG}

# is there an update available?
if [ -f $UPDATE_PATH ]; then
	FLAG_PATH=/misc/.minstalled
	if [ ! -f $FLAG_PATH ]; then
		ACTION=installing
	else
		ACTION=updating
	fi

	# extract the zip file appended to the end of this script to tmp
	# and display one of the two images it contains 
	CUT=$((`busybox grep -n '^BINARY' $0 | busybox cut -d ':' -f 1 | busybox tail -1` + 1))
	busybox tail -n +$CUT "$0" | busybox uudecode -o /tmp/data
	busybox unzip -o /tmp/data -d /tmp
	busybox fbset -g 640 480 640 480 16
	dd if=/tmp/$ACTION of=/dev/fb0
	sync
	
	busybox unzip -o $UPDATE_PATH -d $SDCARD_PATH
	rm -f $UPDATE_PATH
	
	# the updated system finishes the install/update
	$SYSTEM_PATH/bin/install.sh # &> $SDCARD_PATH/install.txt
fi

ROOTFS_IMAGE=$SYSTEM_PATH/rootfs.ext2
if [ ! -f $ROOTFS_IMAGE ]; then
	# fallback to stock demenu.bin, based on dmenu_ln
	ACT="/tmp/.next"
	CMD="/mnt/vendor/bin/dmenu.bin"
	touch "$ACT"
	while [ -f $CMD ]; do
		if $CMD; then
			if [ -f "$ACT" ]; then
				if  ! sh $ACT; then
					echo
				fi
				rm -f "$ACT"
			fi
		fi
	done
	sync && reboot -p
fi

ROOTFS_MOUNTPOINT=/cfw
LOOPDEVICE=/dev/block/loop7
mkdir $ROOTFS_MOUNTPOINT
busybox losetup $LOOPDEVICE $ROOTFS_IMAGE
mount -r -w -o loop -t ext4 $LOOPDEVICE $ROOTFS_MOUNTPOINT
rm -rf $ROOTFS_MOUNTPOINT/tmp/*
mkdir $ROOTFS_MOUNTPOINT/mnt/mmc
mkdir $ROOTFS_MOUNTPOINT/mnt/sdcard
for f in dev dev/pts proc sys mnt/mmc mnt/sdcard # tmp doesn't work for some reason?
do
	mount -o bind /$f $ROOTFS_MOUNTPOINT/$f
done

export PATH=/usr/sbin:/usr/bin:/sbin:/bin:$PATH
export LD_LIBRARY_PATH=/usr/lib/:/lib/
export HOME=$SDCARD_PATH
busybox chroot $ROOTFS_MOUNTPOINT $SYSTEM_PATH/paks/MinUI.pak/launch.sh

umount $ROOTFS_MOUNTPOINT
busybox losetup --detach $LOOPDEVICE
sync && reboot -p

exit 0

BINARY
begin 644 data
M4$L#!!0````(`/0[*5JF7H93]`$``/Z5```*`!P`:6YS=&%L;&EN9U54"0`#
MK,%_9ZS!?V=U>`L``00`````!`````#MV;%J@U`8AN%?A)PEQ(X.H=Z"8[;<
MBI>0L5,Q],;LG9PMJV.&0.LQ:H<2:.)'.:WO0RE"X:5&_8U',P``````````
M````````\&/%QPWM8[VGN_]`CQZ]AWONQE5+C]YO].[^`SUZ]![MJ;^O`0``
M`````*/BK.WM+]I>N8Z[5ZV6U6O21?62.JFC[27>TCII+!,ETXL59F<K&DUO
M5=BK=3\OE::W=F^MF7OWI::7)Z>Z^Q1/=:[IE6%WPPZ+9DQI_3^6ZWJ#2'O3
M8=B*>Z+C.^WF3MP3G<_3J#^(>Y6F-XWF)L[>.)I5(UK=4^^O&S>\IJ<^7S;B
MGOIZ"[VLU?7"V.N_/XOF2QA[Y\QD\Z_+)$U:RWK=;O;?7U3SONU/Z:H[*)*<
M\_TI>+ANS;>W_I0))XOB(2D)3V[Y]6`4]?Q>VGSU^NVYO?!K-QQ<5:\<KF)Z
M_[.G/%]"0W@^JZ\W]3PPY[7S:IBG7C5/Y?->?3_J[Y>%R7KJ^[GZ^\9BGS^\
MN-=H>DM[_E#WEO;\,8U1U7K8MXUYIK$GFO>QKU^IU^MVXWJBZ//;CNN=HOO1
MQAV[NU%V]*)Y[YZ']6*OZ:5G[7KVN-[N:DW/(G^_$$3^?D;>B_W]F[H7^_M5
M]?MD]?MN````````````````````````X$_Z!%!+`P04````"`#T.RE:IEZ&
M4_0!``#^E0``"``<`'5P9&%T:6YG550)``.LP7]GK,%_9W5X"P`!!``````$
M`````.W9L6J#4!B&X5^$G"7$C@ZAWH)CMMR*EY"Q4S'TQNR=G"VK8X9`ZS%J
MAQ)HXD<YK>]#*4+AI4;]C4<S``````````````````#P8\7'#>UCO:>[_T"/
M'KV'>^[&54N/WF_T[OX#/7KT'NVIOZ\!````````H^*L[>TOVEZYCKM7K9;5
M:])%]9(ZJ:/M)=[2.FDL$R73BQ5F9RL:36]5V*MU/R^5IK=V;ZV9>_>EII<G
MI[K[%$]UKNF587?##HMF3&G]/Y;K>H-(>]-AV(I[HN,[[>9.W!.=S].H/XA[
ME:8WC>8FSMXXFE4C6MU3[Z\;-[RFISY?-N*>^GH+O:S5]<+8Z[\_B^9+&'OG
MS&3SK\LD35K+>MUN]M]?5/.^[4_IJCLHDISS_2EXN&[-M[?^E`DGB^(A*0E/
M;OGU8!3U_%[:?/7Z[;F]\&LW'%Q5KQRN8GK_LZ<\7T)#>#ZKKS?U/##GM?-J
MF*=>-4_E\UY]/^KOEX7)>NK[N?K[QF*?/[RXUVAZ2WO^4/>6]OPQC5'5>MBW
MC7FFL2>:][&O7ZG7ZW;C>J+H\]N.ZYVB^]'&';N[47;THGGOGH?U8J_II6?M
M>O:XWNYJ3<\B?[\01/Y^1MZ+_?V;NA?[^U7U^V3U^VX`````````````````
M``````#@3_H$4$L!`AX#%`````@`]#LI6J9>AE/T`0``_I4```H`&```````
M`````*2!`````&EN<W1A;&QI;F=55`4``ZS!?V=U>`L``00`````!`````!0
M2P$"'@,4````"`#T.RE:IEZ&4_0!``#^E0``"``8````````````I($X`@``
M=7!D871I;F=55`4``ZS!?V=U>`L``00`````!`````!02P4&``````(``@">
)````;@0`````
`
end
