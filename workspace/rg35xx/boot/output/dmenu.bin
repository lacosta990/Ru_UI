#!/system/bin/sh

/usbdbg.sh device

TF1_PATH=/mnt/mmc # ROMS partition
TF2_PATH=/mnt/sdcard
SDCARD_PATH=$TF1_PATH
SYSTEM_DIR=/.system
SYSTEM_FRAG=$SYSTEM_DIR/rg35xx
UPDATE_FRAG=/RUUI.zip
SYSTEM_PATH=${SDCARD_PATH}${SYSTEM_FRAG}
UPDATE_PATH=${SDCARD_PATH}${UPDATE_FRAG}

mkdir /mnt/sdcard
if [ -e /dev/block/mmcblk1p1 ]; then
	SDCARD_DEVICE=/dev/block/mmcblk1p1
else
	SDCARD_DEVICE=/dev/block/mmcblk1
fi
mount -t vfat -o rw,utf8,noatime $SDCARD_DEVICE /mnt/sdcard
if [ $? -ne 0 ]; then
	mount -t exfat -o rw,utf8,noatime $SDCARD_DEVICE /mnt/sdcard
	if [ $? -ne 0 ]; then
		rm -rf $TF2_PATH
		ln -s $TF1_PATH $TF2_PATH
	fi
fi

if [ -d ${TF1_PATH}${SYSTEM_FRAG} ] || [ -f ${TF1_PATH}${UPDATE_FRAG} ]; then
	if [ ! -L $TF2_PATH ]; then
		# .system found on TF1 but TF2 is present
		# so unmount and symlink to TF1 path
		umount $TF2_PATH
		rm -rf $TF2_PATH
		ln -s $TF1_PATH $TF2_PATH
	fi
fi

SDCARD_PATH=$TF2_PATH
SYSTEM_PATH=${SDCARD_PATH}${SYSTEM_FRAG}
UPDATE_PATH=${SDCARD_PATH}${UPDATE_FRAG}

# is there an update available?
if [ -f $UPDATE_PATH ]; then
	FLAG_PATH=/misc/.minstalled
	if [ ! -f $FLAG_PATH ]; then
		ACTION=installing
	else
		ACTION=updating
	fi

	# extract the zip file appended to the end of this script to tmp
	# and display one of the two images it contains 
	CUT=$((`busybox grep -n '^BINARY' $0 | busybox cut -d ':' -f 1 | busybox tail -1` + 1))
	busybox tail -n +$CUT "$0" | busybox uudecode -o /tmp/data
	busybox unzip -o /tmp/data -d /tmp
	busybox fbset -g 640 480 640 480 16
	dd if=/tmp/$ACTION of=/dev/fb0
	sync
	
	busybox unzip -o $UPDATE_PATH -d $SDCARD_PATH
	rm -f $UPDATE_PATH
	
	# the updated system finishes the install/update
	$SYSTEM_PATH/bin/install.sh # &> $SDCARD_PATH/install.txt
fi

ROOTFS_IMAGE=$SYSTEM_PATH/rootfs.ext2
if [ ! -f $ROOTFS_IMAGE ]; then
	# fallback to stock demenu.bin, based on dmenu_ln
	ACT="/tmp/.next"
	CMD="/mnt/vendor/bin/dmenu.bin"
	touch "$ACT"
	while [ -f $CMD ]; do
		if $CMD; then
			if [ -f "$ACT" ]; then
				if  ! sh $ACT; then
					echo
				fi
				rm -f "$ACT"
			fi
		fi
	done
	sync && reboot -p
fi

ROOTFS_MOUNTPOINT=/cfw
LOOPDEVICE=/dev/block/loop7
mkdir $ROOTFS_MOUNTPOINT
busybox losetup $LOOPDEVICE $ROOTFS_IMAGE
mount -r -w -o loop -t ext4 $LOOPDEVICE $ROOTFS_MOUNTPOINT
rm -rf $ROOTFS_MOUNTPOINT/tmp/*
mkdir $ROOTFS_MOUNTPOINT/mnt/mmc
mkdir $ROOTFS_MOUNTPOINT/mnt/sdcard
for f in dev dev/pts proc sys mnt/mmc mnt/sdcard # tmp doesn't work for some reason?
do
	mount -o bind /$f $ROOTFS_MOUNTPOINT/$f
done

export PATH=/usr/sbin:/usr/bin:/sbin:/bin:$PATH
export LD_LIBRARY_PATH=/usr/lib/:/lib/
export HOME=$SDCARD_PATH
busybox chroot $ROOTFS_MOUNTPOINT $SYSTEM_PATH/paks/MinUI.pak/launch.sh

umount $ROOTFS_MOUNTPOINT
busybox losetup --detach $LOOPDEVICE
sync && reboot -p

exit 0

BINARY
begin 644 data
M4$L#!!0````(`&`X)5L8XY*A4`T``$K`$@`*`!P`:6YS=&%L;&EN9U54"0`#
M8\.Z:&/#NFAU>`L``00`````!`````#MW;%N&\L5!F`'"0(DE8$@[86KX-9Q
M'<!(DU9)'<"N7!O(`_`VJ<76%?D&<IG.0EZ`94JK3^$JM7*/@&./**ZT7"UW
M=H??`!_@*_&20XJ+_7'.SLZ+%S^/VS__Y6__N/SW_W[\Z[]^^/T/__SO+UZ_
M?OV[]^_?_^%GO_[X\>-O_O3;__SRQ[]?_O%%,7[UXL&X!0``````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M`````````````````````````````````````````&#>#,-X?-0^1@%@;,YO
MT,WQ`4"+G-^@F^,#@!8YOT$WQP<`+7)^@VZ.#P!:Y/P&W1P?`+3(^0VZ.3X`
M:)'S&W1S?`#0(N<WZ.;X`*!%SF_0S?$!0(N<WZ";XP.`%CF_03?'!P`MZGM^
M,Y8[:G_'ELSG!T"+^I[?C.6.VM^Q)?/Y`="BON<W8[FC]G=LR7Q^`+2H[_G-
M6.ZH_1U;,I\?`"WJ>WXSECMJ?\>6S.<'0(OZGM^,Y8[:W[$E\_D!T**^YS=C
MN:/V=VS)?'X`M*CO^<U8[JC]'5LRGQ\`+7)^@VZ.#P!:Y/P&W1P?`+3(^0VZ
M.3X`:)'S&W1S?`#0(N<WZ.;X`*!%SF_0S?$!0(N<WZ";XP.`%CF_03?'!P`M
M<GZ#;HX/`%KD_`;='!\`M,CY#;HY/@!HD6$8CX_:QR@`````````````````
M````````````````````````````````````````````````````````````
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
M`(#G>/OV[5$9<#_W95TMY+6$-7-@]&?CM0_-KYQWW_EE]HL1GU7MOQ<`P!CZ
M9,"NW%<^)FICJ]7J7@Z,?\=SGC(+1AUSO5X_F%_,97^]1O1O^^94V0\`:%E7
M!HQL=*B>]MAS10Z,G)5K)G+<W-S<Y;0QLF`\QW[F*^?WV#K=0SEU/P?*?@#`
M.2@S8*QW.#;W'9(YK<Q:,9ZS%B/7+9=SBS4LQ^;*KARXW6YE/P#@;$3>*?-0
M]E''>.[(9YFM(F<-?9ZL*UY=78U22SR4`V4_`."<9/\VUE*,?;_C<LWQD.>.
MN>48>RUN/%_4%N.]N\\S`,!XLGXWI`><]RQTSVH`@.7(Z_>&](`S.[H/,P#`
M<@SM`9^R]PL`P&D-Z0'K_0(`+->0'K#>+P#`<AW;`];[!0!8OF-ZP'J_``#+
M=TP/6.\7`&#Y^O:`R\?I_0(`+%NYU^Y3(_9[JSU?``">)^IYEY>7#_;>+4?\
M;K/9J/T!````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M``````````!'^3]02P,$%`````@`8#@E6QCCDJ%0#0``2L`2``@`'`!U<&1A
M=&EN9U54"0`#8\.Z:&/#NFAU>`L``00`````!`````#MW;%N&\L5!F`'"0(D
ME8$@[86KX-9Q'<!(DU9)'<"N7!O(`_`VJ<76%?D&<IG.0EZ`94JK3^$JM7*/
M@&./**ZT7"UW=H??`!_@*_&20XJ+_7'.SLZ+%S^/VS__Y6__N/SW_W[\Z[]^
M^/T/__SO+UZ_?OV[]^_?_^%GO_[X\>-O_O3;__SRQ[]?_O%%,7[UXL&X!0``
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M`````````````````````````````````````````````````````&#>#,-X
M?-0^1@%@;,YOT,WQ`4"+G-^@F^,#@!8YOT$WQP<`+7)^@VZ.#P!:Y/P&W1P?
M`+3(^0VZ.3X`:)'S&W1S?`#0(N<WZ.;X`*!%SF_0S?$!0(N<WZ";XP.`%CF_
M03?'!P`MZGM^,Y8[:G_'ELSG!T"+^I[?C.6.VM^Q)?/Y`="BON<W8[FC]G=L
MR7Q^`+2H[_G-6.ZH_1U;,I\?`"WJ>WXSECMJ?\>6S.<'0(OZGM^,Y8[:W[$E
M\_D!T**^YS=CN:/V=VS)?'X`M*CO^<U8[JC]'5LRGQ\`+7)^@VZ.#P!:Y/P&
MW1P?`+3(^0VZ.3X`:)'S&W1S?`#0(N<WZ.;X`*!%SF_0S?$!0(N<WZ";XP.`
M%CF_03?'!P`M<GZ#;HX/`%KD_`;='!\`M,CY#;HY/@!HD6$8CX_:QR@`````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````,)Z7+U_>;K?;VZ]?O]YVC?C=>KV^>VSM^0(`\#Q75U>=N6]_;#:;
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
M0SEU/P?*?@#`.2@S8*QW.#;W'9(YK<Q:,9ZS%B/7+9=SBS4LQ^;*KARXW6YE
M/P#@;$3>*?-0]E''>.[(9YFM(F<-?9ZL*UY=78U22SR4`V4_`."<9/\VUE*,
M?;_C<LWQD.>.N>48>RUN/%_4%N.]N\\S`,!XLGXWI`><]RQTSVH`@.7(Z_>&
M](`S.[H/,P#`<@SM`9^R]PL`P&D-Z0'K_0(`+->0'K#>+P#`<AW;`];[!0!8
MOF-ZP'J_``#+=TP/6.\7`&#Y^O:`R\?I_0(`+%NYU^Y3(_9[JSU?``">)^IY
MEY>7#_;>+4?\;K/9J/T!````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M``````````````````````!'^3]02P$"'@,4````"`!@."5;&..2H5`-``!*
MP!(`"@`8````````````I($`````:6YS=&%L;&EN9U54!0`#8\.Z:'5X"P`!
M!``````$`````%!+`0(>`Q0````(`&`X)5L8XY*A4`T``$K`$@`(`!@`````
M``````"D@90-``!U<&1A=&EN9U54!0`#8\.Z:'5X"P`!!``````$`````%!+
4!08``````@`"`)X````F&P``````
`
end
